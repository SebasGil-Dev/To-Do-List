---
import '../styles/global.css';
---
<div class="flex items-center justify-center py-[12vh]">
    <div class="bg-white rounded-3xl shadow-xl flex flex-col md:flex-row max-w-3xl w-full overflow-hidden">
        <!-- Imagen izquierda -->
        <div class="hidden md:flex md:w-1/2 bg-purple-200 items-center justify-center relative">
            <img src="/portada login.png" alt="Portada login" class="w-full h-full object-cover" />
        </div>

        <!-- Derecha: logo y formulario -->
        <div class="w-full md:w-1/2 p-8 flex flex-col justify-center">
            <!-- Logo -->
            <div class="flex justify-center mb-2">
                <img src="/To-Do List Logo.png" alt="Logo To-Do List" class="h-20 object-contain" draggable="false" />
            </div>

            <!-- Tabs -->
            <div class="flex justify-center items-center mb-6 gap-4" id="login-tabs">
                <button type="button" id="tab-ingresar" class="text-lg font-semibold transition border-b-2 text-red-400 border-red-400">Ingresar</button>
                <span class="text-xl font-thin">|</span>
                <button type="button" id="tab-registrarse" class="text-lg font-semibold transition border-b-2 text-gray-700 border-transparent">Registrarse</button>
            </div>

            <!-- Formulario Ingresar -->
            <form id="form-ingresar" class="space-y-4">
                <input type="text" placeholder="Correo electrónico" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none bg-gray-50" required />
                <input type="password" placeholder="Contraseña" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none bg-gray-50" required />
                <div class="flex justify-between items-center text-xs">
                    <a href="#" class="text-red-400 hover:text-red-500 underline">Recuperar contraseña</a>
                </div>
                <button type="submit" class="w-full bg-red-400 hover:bg-red-500 transition py-2 rounded-md text-white font-semibold text-lg shadow-md active:scale-95">Iniciar sesión</button>
            </form>

            <!-- Formulario Registrarse -->
            <form id="form-registrarse" class="space-y-4 hidden">
                <input type="text" placeholder="Nombre completo" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none bg-gray-50" required />
                <input type="email" placeholder="Correo electrónico" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none bg-gray-50" required />
                <input type="password" placeholder="Contraseña" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none bg-gray-50" required />

                <!-- Términos -->
                <div class="flex items-center gap-2 relative">
                    <input id="terms" name="terms" type="checkbox" required class="h-4 w-4 text-red-400 border-gray-300 rounded" />
                    <label for="terms" class="text-xs text-gray-700">
                        Acepto&nbsp;
                        <span tabindex="0" class="cursor-pointer text-red-400 underline relative" aria-describedby="tooltip-terms" id="tooltip-trigger">términos y condiciones</span>
                    </label>

                    <span role="tooltip" id="tooltip-terms" class="invisible opacity-0 absolute z-10 left-0 bottom-full mb-2 w-56 rounded bg-white border border-gray-300 px-3 py-2 text-black text-xs transition-opacity duration-200 shadow-lg">
                        Esto es una prueba técnica, los términos y condiciones son solo demostrativos.
                    </span>
                </div>

                <button type="submit" class="w-full bg-red-400 hover:bg-red-500 transition py-2 rounded-md text-white font-semibold text-lg shadow-md active:scale-95">Registrarse</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const API_URL = import.meta.env.PUBLIC_API_URL || "https://to-do-listo-api-w1i0.onrender.com";
        console.log("API_URL en login:", API_URL);

        const tabLogin = document.getElementById("tab-ingresar");
        const tabRegister = document.getElementById("tab-registrarse");
        const formLogin = document.getElementById("form-ingresar");
        const formRegister = document.getElementById("form-registrarse");

        // Alternador tabs
        if (tabLogin && tabRegister && formLogin && formRegister) {
            tabLogin.addEventListener("click", () => {
                tabLogin.classList.add("text-red-400", "border-red-400");
                tabLogin.classList.remove("text-gray-700", "border-transparent");
                tabRegister.classList.remove("text-red-400", "border-red-400");
                tabRegister.classList.add("text-gray-700", "border-transparent");
                formLogin.classList.remove("hidden");
                formRegister.classList.add("hidden");
            });

            tabRegister.addEventListener("click", () => {
                tabRegister.classList.add("text-red-400", "border-red-400");
                tabRegister.classList.remove("text-gray-700", "border-transparent");
                tabLogin.classList.remove("text-red-400", "border-red-400");
                tabLogin.classList.add("text-gray-700", "border-transparent");
                formRegister.classList.remove("hidden");
                formLogin.classList.add("hidden");
            });
        }

        // Tooltip términos
        const trigger = document.getElementById("tooltip-trigger");
        const tooltip = document.getElementById("tooltip-terms");
        if (trigger && tooltip) {
            const show = () => {
                tooltip.classList.remove("invisible", "opacity-0");
                tooltip.classList.add("visible", "opacity-100");
            };
            const hide = () => {
                tooltip.classList.add("invisible", "opacity-0");
                tooltip.classList.remove("visible", "opacity-100");
            };
            trigger.addEventListener("mouseenter", show);
            trigger.addEventListener("mouseleave", hide);
            trigger.addEventListener("focus", show);
            trigger.addEventListener("blur", hide);
        }

        if (!API_URL) {
            console.error("PUBLIC_API_URL no está definido. Revisa el .env de Astro y Netlify.");
            return;
        }

        // LOGIN: correo + contraseña
        if (formLogin) {
            formLogin.addEventListener("submit", async (e) => {
                e.preventDefault();

                const inputs = formLogin.querySelectorAll("input");
                const email = inputs[0]?.value.trim();
                const password = inputs[1]?.value;

                if (!email || !password) {
                    alert("Todos los campos son obligatorios.");
                    return;
                }

                try {
                    console.log("Intentando login con:", { email, password });

                    const res = await fetch(`${API_URL}/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password }),
                    });

                    console.log("Status /login:", res.status);

                    let data;
                    try {
                        data = await res.json();
                    } catch (err) {
                        console.error("No se pudo parsear JSON de /login:", err);
                        data = null;
                    }

                    console.log("Respuesta /login:", data);

                    if (!res.ok) {
                        alert(data?.error || "Email inexistente o contraseña incorrecta.");
                        return;
                    }

                    if (!data || !data.token) {
                        alert("El servidor no devolvió un token. Revisa el backend de /login.");
                        return;
                    }

                    localStorage.setItem("token", data.token);
                    if (data.user && data.user.email) {
                        localStorage.setItem("userEmail", data.user.email);
                    }

                    window.location.href = "/inicio";
                } catch (err) {
                    console.error("Error en /login:", err);
                    alert("Error de conexión con el servidor.");
                }
            });
        }

        // REGISTRO: todos los campos obligatorios
        if (formRegister) {
            formRegister.addEventListener("submit", async (e) => {
                e.preventDefault();

                const inputs = formRegister.querySelectorAll("input");
                const name = inputs[0]?.value.trim();
                const email = inputs[1]?.value.trim();
                const password = inputs[2]?.value.trim();
                const termsChecked = (inputs[3] && inputs[3].type === "checkbox") ? inputs[3].checked : false;

                if (!name || !email || !password || !termsChecked) {
                    alert("Todos los campos son obligatorios.");
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/register`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email, password }),
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        alert(data.error || "Error al crear la cuenta.");
                        return;
                    }

                    alert("Cuenta creada con éxito. Ahora puedes iniciar sesión.");
                    if (tabLogin) tabLogin.click();
                } catch (err) {
                    console.error("Error en /register:", err);
                    alert("Error de conexión con el servidor.");
                }
            });
        }
    });
</script>
